-- FUNCTION: public.get_related_ordersheet_ticket_detail(character varying)

-- DROP FUNCTION IF EXISTS public.get_related_ordersheet_ticket_detail(character varying);

CREATE OR REPLACE FUNCTION public.get_related_ordersheet_ticket_detail(
	ticketid character varying)
    RETURNS TABLE(parentid bigint, id bigint, org_id integer, brand_id integer, org_brand_id integer, brand_name text, "Opportunity Name" text, is_visible_in_customer_portal boolean, requested_by bigint, requester text, assigned_to_user_id bigint, assignee text, "AR Rep" text, assigned_to_group_id integer, "group" text, contact_group_id bigint, contact_group text, resolution_due_on timestamp with time zone, ticket_status_id integer, status text, ticket_source_id integer, source text, update_count integer, note_count integer, attachment_count integer, work_log_count integer, total_time_logged integer, total_billable_time_logged integer, first_response_due_on timestamp with time zone, next_response_due_on timestamp with time zone, last_replied_on timestamp with time zone, last_replied_by_id bigint, last_replied_by text, last_replied_by_user_type_id integer, last_replied_by_user_type text, closed_on timestamp with time zone, closed_by bigint, closed_by_name text, created_on timestamp with time zone, created_by bigint, creator text, last_modified_on timestamp with time zone, last_modified_by bigint, "Last Modified By" text, is_spam boolean, is_active boolean, tsv tsvector, is_resolution_date_modified boolean, last_status_changed_on timestamp with time zone, is_first_response_updated boolean, ticket_type_option_id bigint, ticket_category_option_id bigint, ticket_priority_id integer, priority text, "Account Name" text, subject text, type text, category text, email character varying, "OpportunityOwner" text, time_spent bigint, unique_external_reference_id text, agentid bigint, notes text, isnotesprivate boolean, notetype text, assigned text, cf_car_rep text, cf_cg_billing_postal_code character varying, cf_cg_known_company_url character varying, cf_problematic_pricing_opps boolean, cf_cg_billing_street character varying, cf_cg_billing_city character varying, cf_month_three_amount numeric, cf_month_two_amount numeric, cf_month_one_amount numeric, cf_reseller_amount numeric, cf_bold_referral_partner character varying, cf_crr_split_amount numeric, cf_fee_to_alliance_partner numeric, cf_projectdivision_name character varying, cf_total_sale_amount numeric, cf_include_third_party_contractors character varying, cf_record_type character varying, cf_external_reference_id character varying, cf_order_sheet_status character varying, cf_rejected_to_rep timestamp without time zone, cf_submitted_for_processing timestamp without time zone, cf_crr_corrections_required character varying, cf_crr_rep character varying, cf_returnrebook boolean, cf_special_instructionsnotes character varying, cf_submitted_for_approval timestamp without time zone, cf_visual_compliance_run_by character varying, cf_contract_term character varying, cf_month_six_amount numeric, cf_contract_start_date timestamp without time zone, cf_portal_admin_direct_trac_id_packflat character varying, cf_year_one_fee numeric, cf_month_five_amount numeric, cf_order_sheet_processed timestamp without time zone, cf_month_twelve_amount numeric, cf_month_seven_amount numeric, cf_month_nine_amount numeric, cf_year_eight_fee numeric, cf_year_five_fee numeric, cf_year_four_fee numeric, cf_year_nine_fee numeric, cf_year_seven_fee numeric, cf_year_six_fee numeric, cf_year_three_fee numeric, cf_year_two_fee numeric, cf_month_eleven_amount numeric, cf_payment_frequency character varying, cf_payment_terms character varying, cf_order_id_to_renew character varying, cf_premium_support character varying, cf_sales_admin_correction_requested character varying, cf_tss_support character varying, cf_bold_tenant_id_or_portal_name character varying, cf_stripe_order boolean, cf_account_name character varying, cf_associated_dt_order character varying, cf_current_opportunity_stage character varying, cf_order_visual_compliance_run timestamp without time zone, cf_reseller character varying, cf_order_entered date, cf_verified_return_in_dt boolean, cf_order_sheet_name character varying, cf_upgrade_dollar_amount numeric, cf_portal_admin_country character varying, cf_customer_invoice_details character varying, cf_portal_admin_full_name_packflat character varying, cf_payment_confirmation_attached character varying, cf_alliance_fee_tier character varying, cf_csr_returned_for_correction date, cf_alliance_partner character varying, cf_confirmed_order_csr date, cf_contracted_amount_reseller_orders numeric, cf_application_name character varying, cf_product_1_name character varying, cf_main_project_contact_full_name character varying, cf_month_eight_amount numeric, cf_optional_renewal_years character varying, cf_official_company_name character varying, cf_order_entered_by character varying, cf_end_user_1_direct_trac_id character varying, cf_end_user_4_full_name character varying, cf_end_user_2_full_name character varying, cf_end_user_3_full_name character varying, cf_end_user_5_full_name character varying, cf_end_user_3_direct_trac_id character varying, cf_end_user_2_direct_trac_id character varying, cf_end_user_4_direct_trac_id character varying, cf_end_user_5_direct_trac_id character varying, cf_main_project_contact_direct_trac_id character varying, cf_bill_toap_dt_customer_id character varying, cf_manager character varying, cf_taxvat_id character varying, cf_po_number character varying, cf_enterpriseportal_id character varying, cf_contract_signatory_full_name character varying, cf_contract_signatory_dt_customer_id character varying, cf_sales_rep_split_amount numeric, cf_end_user_1_full_name character varying, cf_payment_method character varying, cf_next_renewal_date timestamp without time zone, cf_is_there_a_reseller_involved character varying, cf_is_this_an_upgrade character varying, cf_license_type character varying, cf_portal_admin_time_zone character varying, cf_bold_commissionable_amount numeric, cf_syncfusion_sales_rep character varying, cf_are_vendor_forms_needed character varying, cf_eventual_monthly_payment numeric, cf_month_four_amount numeric, cf_month_ten_amount numeric, cf_returned_for_corrections timestamp without time zone, "Sales Admin Review Days" double precision, "Close Date to Processed" double precision, "Days to Process" double precision, "Days Since Close Date" double precision, "Days Open" double precision, "Call time" text, "CRRB Processing Time" text, "Days to Process(str)" text, "DT Order Link" text, "Days to Submit Order" double precision, "Days to Submit Order_bucket" text, "Annualized Revenue" double precision, "Days To Final CRRB Check" text, "Close to Final CRRB Checks" double precision) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
begin
	return query 

SELECT * 
   FROM dblink('host=35.236.243.204 port=5432 user=salesopreaduser password=b9c!l9M4#zQ dbname=org-538'::text, format('SELECT td.id as parentid,t.id,
    t.org_id,
    t.brand_id,
    t.org_brand_id,
    b.brand_name,
    t.title AS "Opportunity Name",
    t.is_visible_in_customer_portal,
    t.requested_by,
    requester.name AS requester,
    t.assigned_to_user_id,
    assignee.name AS assignee,
	assignee.name as "AR Rep",
    t.assigned_to_group_id,
    aug.name AS "group",
    t.contact_group_id,
    cg.name AS contact_group,
    t.resolution_due_on,
    t.ticket_status_id,
    tst.label_for_agent AS status,
    t.ticket_source_id,
    tso.name AS source,
    t.update_count,
    t.note_count,
    t.attachment_count,
    t.work_log_count,
    t.total_time_logged,
    t.total_billable_time_logged,
    t.first_response_due_on,
    t.next_response_due_on,
    t.last_replied_on,
    t.last_replied_by_id,
    replied.name AS last_replied_by,
    t.last_replied_by_user_type_id,
    rut.name AS last_replied_by_user_type,
    t.closed_on,
    t.closed_by,
    closed.name AS closed_by_name,
    t.created_on,
    t.created_by,
    creator.name AS creator,
    t.last_modified_on,
    t.last_modified_by,
    modifier.name AS "Last Modified By",
    t.is_spam,
    t.is_active,
    t.tsv,
    t.is_resolution_date_modified,
    t.last_status_changed_on,
    t.is_first_response_updated,
    t.ticket_type_option_id,
    t.ticket_category_option_id,
    t.ticket_priority_id,
    tp.name AS priority,
    cg.name AS "Account Name",
    t.title AS subject,
    ( SELECT field_option.option_value
           FROM field_option
          WHERE field_option.id = t.ticket_type_option_id) AS type,
    ( SELECT field_option.option_value
           FROM field_option
          WHERE field_option.id = t.ticket_category_option_id) AS category,
    owner.email,
    owner.name AS "OpportunityOwner",
    timelog.time_spent,
    t.unique_external_reference_id,
    agent.id AS agentid,
    tu.description AS notes,
    tu.is_private AS isnotesprivate,
    tut.name AS notetype,
	creator.name AS Assigned,
    
 carrep.name as cf_car_rep,
  
    contactgroup."1083" AS cf_cg_billing_postal_code,
    contactgroup."1044" AS cf_cg_known_company_url,
    contactgroup."1058" AS cf_problematic_pricing_opps,
    contactgroup."1079" AS cf_cg_billing_street,
    contactgroup."1080" AS cf_cg_billing_city,
   fields."1182"  as "cf_month_three_amount",
fields."1178"  as "cf_month_two_amount",
fields."1174"  as "cf_month_one_amount",
fields."1175"  as "cf_reseller_amount",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1617") as "cf_bold_referral_partner",
fields."1167"  as "cf_crr_split_amount",
fields."1177"  as "cf_fee_to_alliance_partner",
fields."1184"  as "cf_projectdivision_name",
fields."1180"  as "cf_total_sale_amount",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1183") as "cf_include_third_party_contractors",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1046") as "cf_record_type",
fields."1329"  as "cf_external_reference_id",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1141") as "cf_order_sheet_status",
fields."1155"  as "cf_rejected_to_rep",
fields."1153"  as "cf_submitted_for_processing",
fields."1146"  as "cf_crr_corrections_required",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1145") as "cf_crr_rep",
fields."1147"  as "cf_returnrebook",
fields."1150"  as "cf_special_instructionsnotes",
fields."1151"  as "cf_submitted_for_approval",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1144") as "cf_visual_compliance_run_by",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1191") as "cf_contract_term",
fields."1192"  as "cf_month_six_amount",
fields."1188"  as "cf_contract_start_date",
fields."1573"  as "cf_portal_admin_direct_trac_id_packflat",
fields."1194"  as "cf_year_one_fee",
fields."1190"  as "cf_month_five_amount",
fields."1160"  as "cf_order_sheet_processed",
fields."1210"  as "cf_month_twelve_amount",
fields."1195"  as "cf_month_seven_amount",
fields."1204"  as "cf_month_nine_amount",
fields."1205"  as "cf_year_eight_fee",
fields."1200"  as "cf_year_five_fee",
fields."1199"  as "cf_year_four_fee",
fields."1203"  as "cf_year_nine_fee",
fields."1202"  as "cf_year_seven_fee",
fields."1201"  as "cf_year_six_fee",
fields."1197"  as "cf_year_three_fee",
fields."1196"  as "cf_year_two_fee",
fields."1207"  as "cf_month_eleven_amount",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1226") as "cf_payment_frequency",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1225") as "cf_payment_terms",
fields."1239"  as "cf_order_id_to_renew",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1237") as "cf_premium_support",
( SELECT array_to_string(array_agg(field_option.option_value),'';'')
           FROM field_option
          WHERE field_option.id = ANY(fields."1238") limit 1) AS "cf_sales_admin_correction_requested",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1236") as "cf_tss_support",
fields."1360"  as "cf_bold_tenant_id_or_portal_name",
fields."1233"  as "cf_stripe_order",
fields."1356"  as "cf_account_name",
fields."1358"  as "cf_associated_dt_order",
fields."1357"  as "cf_current_opportunity_stage",
fields."1353"  as "cf_order_visual_compliance_run",
fields."1361"  as "cf_reseller",
fields."1459"  as "cf_order_entered",
fields."1460"  as "cf_verified_return_in_dt",
fields."1485"  as "cf_order_sheet_name",
fields."1179"  as "cf_upgrade_dollar_amount",
fields."1574"  as "cf_portal_admin_country",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1232") as "cf_customer_invoice_details",
fields."1208"  as "cf_portal_admin_full_name_packflat",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1149") as "cf_payment_confirmation_attached",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1512") as "cf_alliance_fee_tier",
fields."1515"  as "cf_csr_returned_for_correction",
fields."1362"  as "cf_alliance_partner",
fields."1461"  as "cf_confirmed_order_csr",
fields."1176"  as "cf_contracted_amount_reseller_orders",
fields."1553"  as "cf_application_name",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1235") as "cf_product_1_name",
fields."1552"  as "cf_main_project_contact_full_name",
fields."1198"  as "cf_month_eight_amount",
( SELECT array_to_string(array_agg(field_option.option_value),'';'')
           FROM field_option
          WHERE field_option.id = ANY(fields."1193") limit 1)  as "cf_optional_renewal_years",
fields."1554"  as "cf_official_company_name",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1518") as "cf_order_entered_by",
fields."1561"  as "cf_end_user_1_direct_trac_id",
fields."1559"  as "cf_end_user_4_full_name",
fields."1557"  as "cf_end_user_2_full_name",
fields."1558"  as "cf_end_user_3_full_name",
fields."1560"  as "cf_end_user_5_full_name",
fields."1563"  as "cf_end_user_3_direct_trac_id",
fields."1562"  as "cf_end_user_2_direct_trac_id",
fields."1564"  as "cf_end_user_4_direct_trac_id",
fields."1565"  as "cf_end_user_5_direct_trac_id",
fields."1572"  as "cf_main_project_contact_direct_trac_id",
fields."1571"  as "cf_bill_toap_dt_customer_id",
fields."1355"  as "cf_manager",
fields."1575"  as "cf_taxvat_id",
fields."1576"  as "cf_po_number",
fields."1578"  as "cf_enterpriseportal_id",
fields."1555"  as "cf_contract_signatory_full_name",
fields."1577"  as "cf_contract_signatory_dt_customer_id",
fields."1602"  as "cf_sales_rep_split_amount",
fields."1556"  as "cf_end_user_1_full_name",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1227") as "cf_payment_method",
fields."1189"  as "cf_next_renewal_date",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1173") as "cf_is_there_a_reseller_involved",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1172") as "cf_is_this_an_upgrade",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1171") as "cf_license_type",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1211") as "cf_portal_admin_time_zone",
fields."1240"  as "cf_bold_commissionable_amount",
fields."1365"  as "cf_syncfusion_sales_rep",
( SELECT field_option.option_value FROM field_option WHERE field_option.id = fields."1228") as "cf_are_vendor_forms_needed",
fields."1213"  as "cf_eventual_monthly_payment",
fields."1186"  as "cf_month_four_amount",
fields."1206"  as "cf_month_ten_amount",
fields."1156"  as "cf_returned_for_corrections",
		  

date_part(''day'', fields."1153" - fields."1151") AS "Sales Admin Review Days",
date_part(''day'', fields."1160" - (case when tst1.label_for_agent != ''Closed'' then td.resolution_due_on else td.closed_on end)) AS "Close Date to Processed",
date_part(''day'', fields."1160"-fields."1153") AS "Days to Process",
date_part(''day'', CURRENT_DATE - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) AS "Days Since Close Date",
CASE WHEN tst.label_for_agent = ''Closed'' THEN date_part(''day'', t.closed_on - t.created_on) ELSE date_part(''day'', CURRENT_DATE - t.created_on) END AS "Days Open",

CASE WHEN timelog.time_spent <= 5 THEN ''0 - 5 Min Call'' WHEN timelog.time_spent > 5 AND timelog.time_spent <= 10 THEN ''5 - 10 Min Call'' WHEN timelog.time_spent > 10 AND timelog.time_spent <= 15 THEN ''10 - 15 Min Call'' ELSE ''> 15 Min Call'' END AS "Call time",

CASE WHEN date_part(''day'', fields."1160"-fields."1153") <= 0.5 THEN ''Same Day'' WHEN date_part(''day'', fields."1160"-fields."1153") > 0.5 AND date_part(''day'', fields."1160"-fields."1153") <= 1 THEN ''1 Day'' WHEN date_part(''day'', fields."1160"-fields."1153") > 1 AND date_part(''day'', fields."1160"-fields."1153") <= 2 THEN ''2 Days'' WHEN date_part(''day'', fields."1160"-fields."1153") > 2 AND date_part(''day'', fields."1160"-fields."1153") <= 3 THEN ''3 Days'' WHEN date_part(''day'', fields."1160"-fields."1153") > 3 AND date_part(''day'', fields."1160"-fields."1153") <= 6 THEN ''4 - 6 Days'' WHEN date_part(''day'', fields."1160"-fields."1153") > 6 AND date_part(''day'', fields."1160"-fields."1153") <= 9 THEN ''7 - 9 Days'' ELSE (case when date_part(''day'', fields."1160"-fields."1153") >= 10 then ''10 or More Days'' else null end) END AS "CRRB Processing Time",

CASE WHEN date_part(''day'', fields."1160"-fields."1153") <= 0.5 THEN ''Same Day'' WHEN date_part(''day'', fields."1160"-fields."1153") > 0.5 AND date_part(''day'', fields."1160"-fields."1153") <= 1 THEN ''1 Day'' WHEN date_part(''day'', fields."1160"-fields."1153") > 1 AND date_part(''day'', fields."1160"-fields."1153") <= 2 THEN ''2 Days'' WHEN date_part(''day'', fields."1160"-fields."1153") > 2 AND date_part(''day'', fields."1160"-fields."1153") <= 3 THEN ''3 Days'' ELSE (case when date_part(''day'', fields."1160"-fields."1153")>3 then ''More than 3 Days'' else null end) END AS "Days to Process(str)",

CONCAT(''https://intranet.syncfusion.com/order/'', fields."1522") AS "DT Order Link",

date_part(''day'', fields."1151" - t.created_on) AS "Days to Submit Order",
CASE WHEN date_part(''day'', fields."1151" - t.created_on) <= 0.5 THEN ''Same Day'' WHEN date_part(''day'', fields."1151" - t.created_on) > 0.5 AND date_part(''day'', fields."1151" - t.created_on) <= 1 THEN ''1 Day'' WHEN date_part(''day'', fields."1151" - t.created_on) > 1 AND date_part(''day'', fields."1151" - t.created_on) <= 2 THEN ''2 Days'' WHEN date_part(''day'', fields."1151" - t.created_on) > 2 AND date_part(''day'', fields."1151" - t.created_on) <= 3 THEN ''3 Days'' WHEN date_part(''day'', fields."1151" - t.created_on) > 3 AND date_part(''day'', fields."1151" - t.created_on) <= 6 THEN ''4 - 6 Days'' WHEN date_part(''day'', fields."1151" - t.created_on) > 6 AND date_part(''day'', fields."1151" - t.created_on) <= 9 THEN ''7 - 9 Days'' ELSE (case when date_part(''day'', fields."1151" - t.created_on) >= 10 then ''10 or More Days'' else null end) END AS "Days to Submit Order_bucket",

fields."1174"::double precision + fields."1178"::double precision + fields."1182"::double precision + fields."1186"::double precision + fields."1190"::double precision + fields."1192"::double precision + fields."1195"::double precision + fields."1198"::double precision + fields."1204"::double precision + fields."1206"::double precision + fields."1207"::double precision + fields."1210"::double precision as "Annualized Revenue",

CASE WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 0.5 THEN ''Same Day'' WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) > 0.5 AND date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 1 THEN ''1 Day'' WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) > 1 AND date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 2 THEN ''2 Days'' WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) > 2 AND date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 3 THEN ''3 Days'' WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) > 3 AND date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 6 THEN ''4 - 6 Days'' WHEN date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) > 6 AND date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) <= 9 THEN ''7 - 9 Days'' ELSE (case when date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) >= 10 then ''10 or More Days'' else null end) END AS "Days To Final CRRB Check",
date_part(''day'', fields."1461" - (case when tst.label_for_agent != ''Closed'' then t.resolution_due_on else t.closed_on end)) AS "Close to Final CRRB Checks"

		  
  FROM (select * from ticket_detail where ticket_category_option_id = 4 and id in (%s)) td
     LEFT JOIN ticket_link tl ON tl.destination_ticket_id = td.id AND tl.ticket_link_type_id = 1 and  tl.is_Active=true
     LEFT JOIN ticket_detail t ON t.id = tl.source_ticket_id and t.ticket_category_option_id = 3617 and t.is_active=true
     LEFT JOIN brand b ON b.org_brand_id = t.org_brand_id
     LEFT JOIN ticket_status tst ON tst.id = t.ticket_status_id
     LEFT JOIN ticket_status tst1 ON tst1.id = td.ticket_status_id
     LEFT JOIN ticket_source tso ON tso.id = t.ticket_source_id
     LEFT JOIN users requester ON requester.id = t.requested_by
     LEFT JOIN users replied ON replied.id = t.last_replied_by_id
     LEFT JOIN user_type rut ON rut.id = t.last_replied_by_user_type_id
     LEFT JOIN users creator ON creator.id = t.created_by
     LEFT JOIN users modifier ON modifier.id = t.last_modified_by
     LEFT JOIN ticket_priority tp ON tp.id = t.ticket_priority_id
     LEFT JOIN users assignee ON assignee.id = t.assigned_to_user_id
     LEFT JOIN user_group aug ON aug.id = t.assigned_to_group_id
     LEFT JOIN contact_group cg ON cg.id = t.contact_group_id
     LEFT JOIN users closed ON closed.id = t.closed_by
     LEFT JOIN agent ON t.assigned_to_user_id = agent.user_id
	 LEFt JOIN users owner on agent.user_id = owner.id and owner.user_type_id = 2
   LEFT JOIN (select ticket_id,SUM(time_spent) as time_spent from ticket_time_log group by ticket_id) timelog ON timelog.ticket_id = t.id 
 LEFT JOIN ticket_update tu ON tu.ticket_id = t.id AND tu.is_first_update = true
     LEFT JOIN ticket_update_type tut ON tut.id = tu.ticket_update_type_id,
     jsonb_to_record(t.custom_fields) fields("1182" decimal(36,6),
"1178" decimal(36,6),
"1174" decimal(36,6),
"1175" decimal(36,6),
"1617" bigint,
"1167" decimal(36,6),
"1177" decimal(36,6),
"1184" varchar,
"1180" decimal(36,6),
"1183" bigint,
"1046" bigint,
"1329" varchar,
"1141" bigint,
"1155" timestamp,
"1153" timestamp,
"1146" varchar,
"1145" bigint,
"1147" boolean,
"1150" varchar,
"1151" timestamp,
"1144" bigint,
"1191" bigint,
"1192" decimal(36,6),
"1188" timestamp,
"1573" varchar,
"1194" decimal(36,6),
"1190" decimal(36,6),
"1160" timestamp,
"1210" decimal(36,6),
"1195" decimal(36,6),
"1204" decimal(36,6),
"1205" decimal(36,6),
"1200" decimal(36,6),
"1199" decimal(36,6),
"1203" decimal(36,6),
"1202" decimal(36,6),
"1201" decimal(36,6),
"1197" decimal(36,6),
"1196" decimal(36,6),
"1207" decimal(36,6),
"1226" bigint,
"1225" bigint,
"1239" varchar,
"1237" bigint,
"1238" int[],
"1236" bigint,
"1360" varchar,
"1233" boolean,
"1356" varchar,
"1358" varchar,
"1357" varchar,
"1353" timestamp,
"1361" varchar,
"1459" date,
"1460" boolean,
"1485" varchar,
"1179" decimal(36,6),
"1574" varchar,
"1232" bigint,
"1208" varchar,
"1149" bigint,
"1512" bigint,
"1515" date,
"1362" varchar,
"1461" date,
"1176" decimal(36,6),
"1553" varchar,
"1235" bigint,
"1552" varchar,
"1198" decimal(36,6),
"1193" int[],
"1554" varchar,
"1518" bigint,
"1561" varchar,
"1559" varchar,
"1557" varchar,
"1558" varchar,
"1560" varchar,
"1563" varchar,
"1562" varchar,
"1564" varchar,
"1565" varchar,
"1572" varchar,
"1571" varchar,
"1355" varchar,
"1575" varchar,
"1576" varchar,
"1578" varchar,
"1555" varchar,
"1577" varchar,
"1602" decimal(36,6),
"1556" varchar,
"1227" bigint,
"1189" timestamp,
"1173" bigint,
"1172" bigint,
"1171" bigint,
"1211" bigint,
"1240" decimal(36,6),
"1365" varchar,
"1228" bigint,
"1213" decimal(36,6),
"1186" decimal(36,6),
"1206" decimal(36,6),
"1156" timestamp,
"1335" character varying,
"1522" character varying)
	  LEFT Join users carrep on carrep.email=fields."1335",
     jsonb_to_record(cg.custom_fields) contactgroup("1083" character varying, "1044" character varying, "1058" boolean, "1079" character varying, "1080" character varying, "1170" bigint, "1291" character varying)
			  
			   ',ticketid)) as ticket_detail(parentid bigint,id bigint,
 org_id integer,
 brand_id integer,
 org_brand_id integer,
 brand_name text,
 "Opportunity Name" text,
 is_visible_in_customer_portal boolean,
 requested_by bigint,
 requester text,
 assigned_to_user_id bigint,
 assignee text,
 "AR Rep" text,
 assigned_to_group_id integer,
 "group" text,
 contact_group_id bigint,
 contact_group text,
 resolution_due_on timestamp with time zone,
 ticket_status_id integer,
 status text,
 ticket_source_id integer,
 source text,
 update_count integer,
 note_count integer,
 attachment_count integer,
 work_log_count integer,
 total_time_logged integer,
 total_billable_time_logged integer,
 first_response_due_on timestamp with time zone,
 next_response_due_on timestamp with time zone,
 last_replied_on timestamp with time zone,
 last_replied_by_id bigint,
 last_replied_by text,
 last_replied_by_user_type_id integer,
 last_replied_by_user_type text,
 closed_on timestamp with time zone,
 closed_by bigint,
 closed_by_name text,
 created_on timestamp with time zone,
 created_by bigint,
 creator text,
 last_modified_on timestamp with time zone,
 last_modified_by bigint,
 "Last Modified By" text,
 is_spam boolean,
 is_active boolean,
 tsv tsvector,
 is_resolution_date_modified boolean,
 last_status_changed_on timestamp with time zone,
 is_first_response_updated boolean,
 ticket_type_option_id bigint,
 ticket_category_option_id bigint,
 ticket_priority_id integer,
 priority text,
 "Account Name" text,
 subject text,
 type text,
 category text,
 email character varying,
 "OpportunityOwner" text,
 time_spent bigint,
 unique_external_reference_id text,
 agentid bigint,
 notes text,
 isnotesprivate boolean,
 notetype text,
 assigned text, 
 cf_car_rep text,
 cf_cg_billing_postal_code character varying,
 cf_cg_known_company_url character varying,
 cf_problematic_pricing_opps boolean,
 cf_cg_billing_street character varying,
 cf_cg_billing_city character varying,
  "cf_month_three_amount" decimal(36,6),
"cf_month_two_amount" decimal(36,6),
"cf_month_one_amount" decimal(36,6),
"cf_reseller_amount" decimal(36,6),
"cf_bold_referral_partner" varchar,
"cf_crr_split_amount" decimal(36,6),
"cf_fee_to_alliance_partner" decimal(36,6),
"cf_projectdivision_name" varchar,
"cf_total_sale_amount" decimal(36,6),
"cf_include_third_party_contractors" varchar,
"cf_record_type" varchar,
"cf_external_reference_id" varchar,
"cf_order_sheet_status" varchar,
"cf_rejected_to_rep" timestamp,
"cf_submitted_for_processing" timestamp,
"cf_crr_corrections_required" varchar,
"cf_crr_rep" varchar,
"cf_returnrebook" boolean,
"cf_special_instructionsnotes" varchar,
"cf_submitted_for_approval" timestamp,
"cf_visual_compliance_run_by" varchar,
"cf_contract_term" varchar,
"cf_month_six_amount" decimal(36,6),
"cf_contract_start_date" timestamp,
"cf_portal_admin_direct_trac_id_packflat" varchar,
"cf_year_one_fee" decimal(36,6),
"cf_month_five_amount" decimal(36,6),
"cf_order_sheet_processed" timestamp,
"cf_month_twelve_amount" decimal(36,6),
"cf_month_seven_amount" decimal(36,6),
"cf_month_nine_amount" decimal(36,6),
"cf_year_eight_fee" decimal(36,6),
"cf_year_five_fee" decimal(36,6),
"cf_year_four_fee" decimal(36,6),
"cf_year_nine_fee" decimal(36,6),
"cf_year_seven_fee" decimal(36,6),
"cf_year_six_fee" decimal(36,6),
"cf_year_three_fee" decimal(36,6),
"cf_year_two_fee" decimal(36,6),
"cf_month_eleven_amount" decimal(36,6),
"cf_payment_frequency" varchar,
"cf_payment_terms" varchar,
"cf_order_id_to_renew" varchar,
"cf_premium_support" varchar,
"cf_sales_admin_correction_requested" varchar,
"cf_tss_support" varchar,
"cf_bold_tenant_id_or_portal_name" varchar,
"cf_stripe_order" boolean,
"cf_account_name" varchar,
"cf_associated_dt_order" varchar,
"cf_current_opportunity_stage" varchar,
"cf_order_visual_compliance_run" timestamp,
"cf_reseller" varchar,
"cf_order_entered" date,
"cf_verified_return_in_dt" boolean,
"cf_order_sheet_name" varchar,
"cf_upgrade_dollar_amount" decimal(36,6),
"cf_portal_admin_country" varchar,
"cf_customer_invoice_details" varchar,
"cf_portal_admin_full_name_packflat" varchar,
"cf_payment_confirmation_attached" varchar,
"cf_alliance_fee_tier" varchar,
"cf_csr_returned_for_correction" date,
"cf_alliance_partner" varchar,
"cf_confirmed_order_csr" date,
"cf_contracted_amount_reseller_orders" decimal(36,6),
"cf_application_name" varchar,
"cf_product_1_name" varchar,
"cf_main_project_contact_full_name" varchar,
"cf_month_eight_amount" decimal(36,6),
"cf_optional_renewal_years" varchar,
"cf_official_company_name" varchar,
"cf_order_entered_by" varchar,
"cf_end_user_1_direct_trac_id" varchar,
"cf_end_user_4_full_name" varchar,
"cf_end_user_2_full_name" varchar,
"cf_end_user_3_full_name" varchar,
"cf_end_user_5_full_name" varchar,
"cf_end_user_3_direct_trac_id" varchar,
"cf_end_user_2_direct_trac_id" varchar,
"cf_end_user_4_direct_trac_id" varchar,
"cf_end_user_5_direct_trac_id" varchar,
"cf_main_project_contact_direct_trac_id" varchar,
"cf_bill_toap_dt_customer_id" varchar,
"cf_manager" varchar,
"cf_taxvat_id" varchar,
"cf_po_number" varchar,
"cf_enterpriseportal_id" varchar,
"cf_contract_signatory_full_name" varchar,
"cf_contract_signatory_dt_customer_id" varchar,
"cf_sales_rep_split_amount" decimal(36,6),
"cf_end_user_1_full_name" varchar,
"cf_payment_method" varchar,
"cf_next_renewal_date" timestamp,
"cf_is_there_a_reseller_involved" varchar,
"cf_is_this_an_upgrade" varchar,
"cf_license_type" varchar,
"cf_portal_admin_time_zone" varchar,
"cf_bold_commissionable_amount" decimal(36,6),
"cf_syncfusion_sales_rep" varchar,
"cf_are_vendor_forms_needed" varchar,
"cf_eventual_monthly_payment" decimal(36,6),
"cf_month_four_amount" decimal(36,6),
"cf_month_ten_amount" decimal(36,6),
"cf_returned_for_corrections" timestamp,
  "Sales Admin Review Days" double precision,
 "Close Date to Processed" double precision,
 "Days to Process" double precision,

 "Days Since Close Date" double precision,
 "Days Open" double precision,

 "Call time" text,
 
 "CRRB Processing Time" text,
 
 "Days to Process(str)" text,
 
 "DT Order Link" text,
 
 "Days to Submit Order" double precision,
 "Days to Submit Order_bucket" text,
 "Annualized Revenue" double precision,
											"Days To Final CRRB Check"  text,
 "Close to Final CRRB Checks" double precision)
 where ticket_detail.id >0 ;
	end;
$BODY$;

ALTER FUNCTION public.get_related_ordersheet_ticket_detail(character varying)
    OWNER TO bolddeskuser;
